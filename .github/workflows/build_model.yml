name: Build and Deploy Edge Impulse Model

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate secrets
        run: |
          if [ -z "$PROJECT_ID" ]; then
            echo "ERROR: PROJECT_ID secret is not set"
            exit 1
          fi
          if [ -z "$API_KEY" ]; then
            echo "ERROR: API_KEY secret is not set"
            exit 1
          fi
          echo "Secrets validated successfully"
        env:
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          API_KEY: ${{ secrets.API_KEY }}

      - name: Build Edge Impulse Model
        uses: edgeimpulse/build-deploy@v2.0.0
        id: build-deploy
        with:
          project_id: ${{ secrets.PROJECT_ID }}
          api_key: ${{ secrets.API_KEY }}
          deployment_type: "zip"
        continue-on-error: false

      - name: List generated files
        run: |
          echo "Generated files:"
          ls -la

      - name: Extract deployment
        if: success()
        run: |
          if [ -f "${{ steps.build-deploy.outputs.deployment_file_name }}" ]; then
            echo "Extracting deployment..."
            mkdir -p temp
            if unzip -q "${{ steps.build-deploy.outputs.deployment_file_name }}" -d temp; then
              echo "Extraction successful"
              # Move components to project structure
              mkdir -p libs src models
              if [ -d "temp/edge-impulse-sdk" ]; then
                mv temp/edge-impulse-sdk libs/
                echo "Moved edge-impulse-sdk to libs/"
              fi
              if [ -d "temp/model-parameters" ]; then
                mv temp/model-parameters src/
                echo "Moved model-parameters to src/"
              fi
              if [ -d "temp/tflite-model" ]; then
                mv temp/tflite-model/* models/ 2>/dev/null || true
                echo "Moved tflite-model files to models/"
              fi
              # Clean up
              rm -rf temp "${{ steps.build-deploy.outputs.deployment_file_name }}"
              echo "Cleanup completed"
            else
              echo "Failed to extract deployment file"
              ls -la "${{ steps.build-deploy.outputs.deployment_file_name }}"
              exit 1
            fi
          else
            echo "No deployment file found"
            ls -la
            exit 1
          fi

      - name: Update version file
        run: |
          echo "Build Date: $(date)" > version.txt
          echo "Commit: ${{ github.sha }}" >> version.txt
          echo "Project ID: ${{ secrets.PROJECT_ID }}" >> version.txt

      - name: Commit generated files
        if: github.event_name == 'push'
        run: |
          echo "Checking for generated files..."
          ls -la libs/ src/ models/ version.txt 2>/dev/null || echo "Some files/directories not found"

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          echo "Adding files to git..."
          git add -f libs/ src/ models/ version.txt || true

          echo "Checking git status..."
          git status --porcelain

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            echo "Committing changes..."
            git commit -m "Auto-build: Update Edge Impulse model [skip ci]"
            echo "Pushing changes..."
            git push
            echo "Push completed successfully"
          fi
